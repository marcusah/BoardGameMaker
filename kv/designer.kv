#:import HoverBehavior utils.hoverable.HoverBehavior
#:import CARD conf.card_format
#:import RuledScatter designer.RuledScatter
#:import Field fields.Field

<FieldTaskButton@ButtonBehavior+HoverBehavior+Image>
    radius: 40
    size_hint_x: None
    width: 50
    canvas.before:
        Color:
            rgb: 1,1,1
        Ellipse:
            pos: self.center_x-self.radius/2, self.center_y-self.radius/2
            size: self.radius, self.radius
        Color:
            rgba: (0,0,1,1) if self.hovered and not(self.disabled) else (0,0,0,0)
        Line:
            circle: self.center_x, self.center_y, self.radius/2
            width: self.radius/20


<TreeFieldEntry>:
#Use on the right tree containing added field
    padding: 10,0,10,0
    size_hint_y: None
    height: 30
    orientation: 'horizontal'
#:import isfile os.path.isfile
    Image:
        source: "img/%s.png"%root.target.Type if root.target and isfile("img/%s.png"%root.target.Type) else "img/misc.png"
        size_hint: .25,1
    Label:
        text: (root.target.name or root.target.Type[:-5] if root.target and isinstance(root.target, Field) and root.target.Type.endswith('Field') else (root.target.Type if root.target and isinstance(root.target, Field) else ""))
        size_hint: .75,1

<FieldEntry@ButtonBehavior+HoverBehavior+BoxLayout>:
#Used in the left scrollview with all potential fields
    text: ""
    source: ""
    padding: 10,0,10,0
    size_hint_y: None
    height: 50
    orientation: 'horizontal'
    on_press: self.target.add_field(args[0]) if self.parent else None
    canvas.before:
        Color:
            rgba: (.3,.3,1, .5) if self.hovered else (0,0,0,0)
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        source: root.source if root.source else "img/%s.png"%root.text if root.text else "img/misc.png"
        size_hint: .25,1
    Label:
        text: root.text[:-5] if root.text.endswith('Field') else root.text
        size_hint: .75,1
        shorten: True

<TmplFieldEntry@ButtonBehavior+HoverBehavior+BoxLayout>:
    source: ""
    padding: 10,0,10,0
    size_hint_y: None
    height: 50
    orientation: 'horizontal'
    on_press: self.target.add_template() if self.parent else None
    text:"Template"
    canvas.before:
        Color:
            rgba: (.3,.3,1, .5) if self.hovered else (0,0,0,0)
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        source: root.source if root.source else "img/%s.png"%root.text if root.text else "img/misc.png"
        size_hint: .25,1
    Label:
        text: root.text[:-5] if root.text.endswith('Field') else root.text
        size_hint: .75,1
        shorten: True

<LinkedFieldEntry@ButtonBehavior+HoverBehavior+BoxLayout>:
    source: ""
    padding: 10,0,10,0
    size_hint_y: None
    height: 50
    orientation: 'horizontal'
    on_press: self.target.add_parent_field(args[0]) if self.parent else None
    text:"Template"
    canvas.before:
        Color:
            rgba: (.3,.3,1, .5) if self.hovered else (0,0,0,0)
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        source: root.source if root.source else "img/%s.png"%root.text if root.text else "img/misc.png"
        size_hint: .25,1
    Label:
        text: root.text[:-5] if root.text.endswith('Field') else root.text
        size_hint: .75,1
        shorten: True


<ImageSpinnerOption@SpinnerOption>:
    size_hint_x: None
    halign: 'right'
    valign: 'middle'
    text_size: .9*root.width, root.height#root.size
    font_size: '14dp'
    width: 80
    Image:
        source: "img/%s.png"%root.text if root.text else ""
        size: root.size[0]/2,root.size[1]/2
        #size: root.size
        pos: root.x-root.width/16,root.y+root.height/4

<ImageSpinner@Spinner>:
    option_cls: "ImageSpinnerOption"
    size_hint_x: None
    width: 80
    background_color: 0,.2,1,.6

<BGDesigner>:
    BoxLayout:
        orientation: "horizontal"
        Splitter:
            size_hint: .24,1
            sizable_from: 'right'
            max_size: 0.5*root.width
            TabbedPanel:
                do_default_tab: False
                #tab_pos: 'left_top'

                TabbedPanelItem:
                    text: 'Widgets'
                    GridLayout:
                        #size_hint_y: None
                        cols: 1
                        #Field Grid
                        Accordion:
                            id: left_accordion
                            #size_hint: .2,1
                            canvas.before:
                                Color:
                                    rgb: .6,.6,.6,
                                Rectangle:
                                    size: self.size
                                    pos: self.pos
                            orientation: 'vertical'
                            AccordionItem:
                                title: 'Fields'
                                collapse: False
                                ScrollView:
                                    GridLayout:
                                        cols: 1
                                        id: fields_stack
                                        size_hint_y: None
                                        on_minimum_height: self.height = self.minimum_height
                            AccordionItem:
                                title: "Shapes"
                                GridLayout:
                                    cols: 1
                                    id: shapes_stack
                            AccordionItem:
                                title: "Linked"
                                GridLayout:
                                    cols: 1
                                    id: effects_stack


                TabbedPanelItem:
                    text: 'Template'
                    GridLayout:
                        #size_hint_y: None
                        cols: 1
                        BoxLayout:
                            orientation: 'horizontal'
                            size_hint_y: None
                            height: 30
                            canvas.before:
                                Color:
                                    rgb: .3,.3,.9,.5
                                Rectangle:
                                    size: self.size
                                    pos: self.pos
                            FieldTaskButton:
                                size_hint_x: .25
                                source: 'img/filenew.png'
                                on_press: root.new()
                                radius: .8*self.parent.height
                            FieldTaskButton:
                                size_hint_x: .25
                                source: 'img/filesave.png'
                                on_press: root.save(); app.set_screen('Deck')
                                radius: .8*self.parent.height
                            FieldTaskButton:
                                size_hint_x: .25
                                source: 'img/filesaveas.png'
                                on_press: root.save()
                                radius: .8*self.parent.height
                            FieldTaskButton:
                                size_hint_x: .25
                                source: 'img/fileopen.png'
                                radius: .8*self.parent.height
                        BoxLayout:
                            orientation: "horizontal"
                            size_hint_y: None
                            height: 30
                            Label:
                                text: "Name: "
                                size_hint_x: None
                                width: 50
                            TextInput:
                                id: tmplName
                                text: "TMPL"
                                on_text: if root.current_template: root.current_template.name = tmplName.text
                        BoxLayout:
                            orientation: 'horizontal'
                            size_hint_y: None
                            height: 30
                            Label:
                                text: "W:"
                                size_hint_x: .1
                            TextInput:
                                id: tmpl_width
                                text: "%.2f"%CARD.width
                                on_text: root.update_tmpl_size()
                                size_hint_x: .3
                            Label:
                                text: "H:"
                                size_hint_x: .1
                            TextInput:
                                id: tmpl_height
                                text: "%.2f"%CARD.height
                                on_text: root.update_tmpl_size()
                                size_hint_x: .3
                            Spinner:
                                values: 'px','cm'
                                text: 'px'
                                on_text: root.change_tmpl_unit()
                                size_hint_x: .2
                                id: tmpl_unit
                        BoxLayout:
                            size_hint_y: None
                            height: 30
                            CheckBox:
                                id: cb_overwrite
                                size_hint_x: .1
                            Label:
                                text: "Overwrite on save"
                        BoxLayout:
                            size_hint_y: None
                            height: 30
                            CheckBox:
                                id: cb_relative
                                active: True
                                size_hint_x: .1
                            Label:
                                text: "Save relative Size/Pos"
                        BoxLayout:
                            size_hint_y: None
                            height: 30
                            CheckBox:
                                id: cb_cm
                                size_hint_x: .1
                                active: True
                            Label:
                                text: "Save in cm"

                        Button:
                            text: "Export"
                            on_press: root.save()
                            size_hint_y: None
                            height: 30
                        Button:
                            text: "Return to Deck"
                            on_press: app.set_screen('Deck')
                            size_hint_y: None
                            height: 30
                        Button:
                            text: "Preview"
                            #:import F kivy.factory.Factory
                            on_press: F.Popup(title='Template Preview', size_hint=(None,None), width=.8*root.width, height=.8*root.height, pos=(.1*root.width,.1*root.height), content=F.Label(text=root.export_kv().replace('\t','    ').replace('\r\n','\n'))).open()
                            size_hint_y: None
                            height: 30


                        BoxLayout:
                            size_hint_y: None
                            height: 30
                            Label:
                                text: "Zoom:"
                                padding_x: 20
                                size_hint_x: .1
                                width: 30
                            Slider:
                                range:0.01,2
                                value: 1
                                on_value: content.scale = self.value#; content.pos= 150,50
                                orientation: 'horizontal'
                                canvas.before:
                                    Color:
                                        rgba: .2,.2,.2,.2
                                    Rectangle:
                                        pos: self.pos
                                        size: self.size

                        ScrollView:
                            FieldTreeView:
                                designer: root
                                indent_level: 0
                                #hide_root: True
                                size_hint_y: None
                                #size_hint_x: None
                                width: self.parent.width if self.parent else 200
                                on_minimum_height: self.height = self.minimum_height
                                on_minimum_width: self.width= self.minimum_width
                                id: fields
                                root_options: {'text': 'Fields'}
                                canvas.before:
                                    Color:
                                        rgb: .2,.2,.2
                                    Rectangle:
                                        size: self.size
                                        pos: self.pos
        #Center layout, with template
        FloatLayout
            size_hint: .65,1
            id: background
            canvas.before:
                Color:
                    rgb: 1,1,1
                Rectangle:
                    size: self.size
                    pos: self.pos

            #Top control scroll, activated when a selection is made
            ScrollView:
                pos: background.x, background.top - self.height
                size_hint: None, None
                height: 50
                width: background.width
                canvas.before:
                    Color:
                        rgba: (0,0,1,.6) if root.selection else (0,0,0,0)
                    Rectangle:
                        size: self.size
                        pos: self.pos
                GridLayout:
                    rows: 1
                    on_minimum_width: self.width= self.minimum_width
                    id: tasks
                    size_hint_x:  None
                    #col_default_width: 60
            #Bottom params details, activated when a selection is made
            Splitter:
                keep_within_parent: True
                sizable_from: 'top'
                height: 0 if not root.selection else 100
                x: background.x
                size_hint: None, None
                #height: 100
                width: background.width
                ScrollView:
                    canvas.before:
                        Color:
                            rgba: (.3,.3,.3,1) if root.selection else (0,0,0,0)
                        Rectangle:
                            size: self.size
                            pos: self.pos
                    TreeView:
                        #rows: 1
                        on_minimum_height: self.height= self.minimum_height
                        id: params
                        size_hint_y:  None
                        #hide_root: bool(root.selection)
                        root_options: {'text' : "%s: %s"%(root.selection[0].Type,root.selection[0].name)} if root.selection else {}

            RuledScatter:
                id: content
                do_rotation: False
                do_scale: False
                pos: background.x+50,150
                size_hint: None, None
                size: CARD.width, CARD.height
                canvas.before:
                    Color:
                        rgba: .5,.5,.5,.5
                    Rectangle:
                        pos: 0,0
                        size: self.size
                    Color:
                        rgb: 0,0,0
                    Line:
                        rectangle: 0,0,self.width,self.height

<TmplChoicePopup>:
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: "Choose Template to Include"
            size_hint_y: None
            height: 30
        ScrollView:
            GridLayout:
                size_hint_y: None
                height: root.height - 70
                on_minimum_height: self.height = self.minimum_height
                cols: 3
                id: tmpl_list
        BoxLayout:
            size_hint_y: None
            height: 40
            #Button:
            #    text: "Apply"
            #    on_press: root.dismiss() ; root.cb()
            Button:
                text: "Cancel"
                on_press: root.dismiss()